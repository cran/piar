<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Adjusting annual weights</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Adjusting annual weights</h1>



<p>Making a monthly or quarterly Lowe index with annual expenditure or
revenue weights requires adjusting these weights so that the implicit
annual quantity vector is used as the fixed basket when making the index
with the usual two-step procedure. This can be done by price updating
the annual weights to the base period of the index, and it serves as a
good example of extending the functions in this package.</p>
<p>Letâ€™s start by making some annual weights and quarterly indexes for a
year.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">54321</span>)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">library</span>(piar)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="co"># Make an aggregation structure.</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="co">#                  1</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="co">#      |-----------|-----------|</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="co">#      11          12          13</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="co">#  |---+---|   |---+---|   |---+---|</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="co"># 111     121 121     122 131     132</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>pias <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>  <span class="at">level1 =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">12</span>),</span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>  <span class="at">level2 =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">11</span>, <span class="dv">12</span>, <span class="dv">13</span>), <span class="at">each =</span> <span class="dv">4</span>),</span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>  <span class="at">level3 =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">111</span>, <span class="dv">112</span>, <span class="dv">121</span>, <span class="dv">122</span>, <span class="dv">131</span>, <span class="dv">132</span>), <span class="at">each =</span> <span class="dv">2</span>),</span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>  <span class="at">ea =</span> <span class="fu">sprintf</span>(<span class="st">&quot;B%02d&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>),</span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>  <span class="at">weight =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a>  <span class="fu">as_aggregation_structure</span>()</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a>pias</span></code></pre></div>
<pre><code>## Aggregation structure for 12 elementary aggregates with 3 levels above the elementary aggregates 
##    level1 level2 level3  ea weight
## 1       1     11    111 B01      1
## 2       1     11    111 B02      2
## 3       1     11    112 B03      3
## 4       1     11    112 B04      4
## 5       1     12    121 B05      5
## 6       1     12    121 B06      6
## 7       1     12    122 B07      7
## 8       1     12    122 B08      8
## 9       1     13    131 B09      9
## 10      1     13    131 B10     10
## 11      1     13    132 B11     11
## 12      1     13    132 B12     12</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Make elementary indexes over 4 quarters.</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>elementals <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>  <span class="fu">runif</span>(<span class="dv">12</span> <span class="sc">*</span> <span class="dv">4</span>, <span class="fl">0.4</span>, <span class="fl">1.2</span>),</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>  <span class="at">nrow =</span> <span class="dv">12</span>,</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>  <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">sprintf</span>(<span class="st">&quot;B%02d&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>), <span class="fu">paste0</span>(<span class="st">&quot;Q&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>))</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>  <span class="fu">as_index</span>()</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>elementals</span></code></pre></div>
<pre><code>## Period-over-period price index for 12 levels over 4 time periods 
##       time
## levels        Q1        Q2        Q3        Q4
##    B01 0.7432063 0.4362399 1.1441564 1.1277327
##    B02 0.7987443 0.9221768 0.8326890 0.9997250
##    B03 0.5413539 1.1952528 0.9594449 1.0966120
##    B04 0.6195148 0.9421099 1.0672886 0.8581942
##    B05 0.5732081 1.1348361 0.4098346 1.1227607
##    B06 1.0930889 0.7699560 1.1682339 0.5616191
##    B07 0.4395281 0.8571318 0.9445658 0.9494140
##    B08 0.5673079 0.7615511 0.4677992 0.7279183
##    B09 0.6732899 0.5341656 1.1756704 1.1541544
##    B10 0.6973270 0.4546091 0.4928318 0.8646791
##    B11 0.5093139 1.1175286 1.1014889 0.8980850
##    B12 0.9408381 0.6190696 0.7101399 1.1024539</code></pre>
<p>Adjusting the weights is simple when there are no missing elementary
indexes: the weight for each elementary aggregate is just divided by the
average (fixed-base) index for each quarter.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">weights</span>(pias) <span class="sc">/</span> <span class="fu">rowMeans</span>(<span class="fu">as.matrix</span>(<span class="fu">chain</span>(elementals)))</span></code></pre></div>
<pre><code>##       B01       B02       B03       B04       B05       B06       B07       B08 
##  2.154344  2.896610  4.819251  6.777709 11.175522  6.916156 18.543541 23.728960 
##       B09       B10       B11       B12 
## 18.520664 30.635776 19.396354 20.059400</code></pre>
<p>The procedure is more complicated with missing elementary indexes as
reaggregating these indexes with the newly adjusted weights will
generally result in different imputations for the missing elementary
indexes, which in turn gives a different adjustment for the weights. In
practice this procedure is done a few times until the index values
converge to a fixed point. The following function shows how to do this
adjustment using the tools in this package.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># Function to adjust annual weights.</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>adjust_weights <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>  index,</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>  pias,</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>  <span class="at">tol =</span> .Machine<span class="sc">$</span>double.eps<span class="sc">^</span><span class="fl">0.5</span>,</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>  <span class="at">max_iter =</span> <span class="dv">100</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>) {</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>  adj_pias <span class="ot">&lt;-</span> pias</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(max_iter)) {</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>    <span class="co"># Parentally impute missing elementary indexes.</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>    agg_index <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(index, adj_pias, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">contrib =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>    elementals <span class="ot">&lt;-</span> <span class="fu">chain</span>(agg_index[<span class="fu">levels</span>(pias)[[<span class="fu">nlevels</span>(pias)]]])</span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>    <span class="co"># Compute annual elementary indexes.</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>    pb <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(<span class="fu">as.matrix</span>(elementals))</span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>    <span class="co"># Stop if average price-update weights are within tolerance of original</span></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>    <span class="co"># weights; adjust otherwise.</span></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">max</span>(<span class="fu">abs</span>(pb <span class="sc">*</span> <span class="fu">weights</span>(adj_pias) <span class="sc">-</span> <span class="fu">weights</span>(pias))) <span class="sc">&lt;</span> tol) {</span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>      <span class="fu">message</span>(<span class="fu">gettextf</span>(<span class="st">&quot;Converged after %d iterations&quot;</span>, i <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a>      <span class="fu">return</span>(adj_pias)</span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a>      <span class="fu">weights</span>(adj_pias) <span class="ot">&lt;-</span> <span class="fu">weights</span>(pias) <span class="sc">/</span> pb</span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a>    }</span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a>  }</span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="st">&quot;weights adjustment did not converge&quot;</span>)</span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a>  adj_pias</span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>elementals[<span class="dv">11</span><span class="sc">:</span><span class="dv">12</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="fu">adjust_weights</span>(elementals, pias)</span></code></pre></div>
<pre><code>## Converged after 2 iterations</code></pre>
<pre><code>## Aggregation structure for 12 elementary aggregates with 3 levels above the elementary aggregates 
##    level1 level2 level3  ea    weight
## 1       1     11    111 B01  2.154344
## 2       1     11    111 B02  2.896610
## 3       1     11    112 B03  4.819251
## 4       1     11    112 B04  6.777709
## 5       1     12    121 B05 11.175522
## 6       1     12    121 B06  6.916156
## 7       1     12    122 B07 18.543541
## 8       1     12    122 B08 23.728960
## 9       1     13    131 B09 18.520664
## 10      1     13    131 B10 30.635776
## 11      1     13    132 B11 28.458991
## 12      1     13    132 B12 31.046172</code></pre>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
